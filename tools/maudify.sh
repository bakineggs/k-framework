#/bin/bash
FILE="$1"

OPS=$(cat "$FILE" |\
sed -e :a -e '$!N; s/\n/ (KEOLN) /g; ta' |\
sed 's/(KEOLN)[ ]*(KEOLN)/(KEOLN)/g' |\
sed 's/\([\t ]context[\t ]\|[\t ]rule[\t ]\|[\t ]configuration[\t ]\|[\t ]op\(s\)\?[\t ]\|[\t ]\(c\)\?eq[\t ]\|[\t ]\(c\)\?rl[\t ]\|[\t ]kvar\(s\)\?[\t ]\|[\t ]\(c\)\?mb[\t ]\|[\t ]sort\(s\)\?[\t ]\|[\t ]subsort\(s\)\?[\t ]\|[\t ]including[\t ]\|[\t ]kmod[\t ]\|[\t ]endkm\|[\t ]mod[\t ]\|[\t ]endm\|[^-]---\)/\n  \1/g' |\
grep '^[[:space:]]*configuration' |\
sed 's/>[^<]*</></g' |\
sed 's/^[^<]\+</</g' |\
sed 's/>[^>]\+$/>/g' |\
sed 's/<\/[^>]\+>//g' |\
sed 's/[\t ]//g; s/<//g; s/\*\?>/ /g' |\
sed 's|\\|\\\\/|g'
)
OPS=" ops $OPS : -> CellLabel\n" 


cat "$FILE" |\
sed -e :a -e '$!N; s/\n/ (KEOLN) /g; ta' |
sed 's/\([\t ]context[\t ]\|[\t ]rule[\t ]\|[\t ]configuration[\t ]\|[\t ]op\(s\)\?[\t ]\|[\t ]\(c\)\?eq[\t ]\|[\t ]\(c\)\?rl[\t ]\|[\t ]kvar\(s\)\?[\t ]\|[\t ]\(c\)\?mb[\t ]\|[\t ]sort\(s\)\?[\t ]\|[\t ]subsort\(s\)\?[\t ]\|[\t ]including[\t ]\|[\t ]kmod[\t ]\|[\t ]endkm\|[\t ]mod[\t ]\|[\t ]endm\|[^-]---\)/\n  \1/g' |\
sed "s<^[\t ]\+configuration <$OPS\0<g" |\
sed 's/\((KEOLN)[\t ]*\)\+$/\n\0 /g' |\
sed 's/[\t ]kmod[\t ]/ mod /g;s/[\t ]endkm/ endm/g' |\
sed 's/^\([\t ]*\)\(op[\t ]\|ops[\t ]\|\(c\)\?eq[\t ]\|\(c\)\?rl[\t ]\|\(c\)\?mb[\t ]\|sort\(s\)\?[\t ]\|subsort\(s\)\?[\t ]\|kvar\(s\)\?[\t ]\|including[\t ]\)\(.*\)$/\1\2\9 ./g' |\
sed 's/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g; s/\(kvars\?[\t ][^,]*\),/\1 .\n kvars /g'|sed 's/[\t ]\(kvar\(s\)\?\)[\t ]/ var\2 /g' |\
sed 's/^\([\t ]*\)\(context[\t ]\|rule[\t ]\|configuration[\t ]\)[\t ]*\([[][^][]\+[]][\t ]*:[\t ]\+\)\?\(.*\)$/\1mb \3\2\4: KSentence ./g' |\
sed 's/\(structural\|hybrid\|arity[\t ][0-9]\+\|\(seq\)\?strict\([\t ]*([0-9 ]\+)\)\?\)/metadata "\1"/g' |\
sed 's/metadata[\t ]\+"\([^"]*\)"[\t ]\+metadata[ ]\+"/metadata "\1 /g' |\
sed 's/[[][\t ]*\(metadata\|print\)\([^]]\+\)[]][\t ]*:[\t ]KSentence/ : KSentence [\1\2]/g' |\
sed 's|\(<[^ \t/<>_][^ \t<>]*_\?>\)| \1( |g' |\
sed 's/\(<_\?\/[^\t <>]\+>\)/ )\1 /g' |\
sed 's|\(<[^\t /<>]\+\)_>|\1>...|g ; s|<_\(/[^\t <>]\+>\)|...<\1|g' |\
sed 's/\([^`][]{}()[,\t ]\)_\([]{}()[,\t ]\)/\1?\2/g' |\
sed 's/\([^`][]{}()[,\t ]\)_\([]{}()[,\t ]\)/\1?\2/g' |\
sed 's/<\(\/\?\)[\t ]*\([^\t <>]\+\)[\t ]*\*[\t ]*>/ <\1 \2 * > /g' |\
sed 's/<\(\/\?\)[\t ]*\([^\t <>]\+\)[\t ]*>/<\1 \2 >/g' |\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\(^[ \t]*\(c\?mb\|c\?eq\|c\?rl\) .*[^`][][{}(),\t ]\)\([^][{}():`,\t ]\+\):\(\([^][{}():`,\t ]\|`[][{}(),]\)[^][{}():`,\t ]*\(`[][{}(),]\?[^][{}():`,\t ]*\)*\)/ var \3 : \4 .\n\1\3/g;'|\
sed 's/\([^`][]{}()[,\t ]\)\.\(Set\|Map\|List\|Bag\|K\)\([]}()[,\t ]\)/\1(.).\2\3/g' |\
sed -e :a -e '$!N; s/\n/ /g; ta' |\
sed 's/(KEOLN)/\n/g' |\
sed 's/\.kmaude//g'
